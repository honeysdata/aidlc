# Business Logic Model - Backend API

## 1. 인증 프로세스

### 1.1 테이블 로그인 플로우

```
[테이블 로그인 요청]
        |
        v
+------------------+
| 매장 ID 검증     |
+--------+---------+
         |
    유효? |
    +----+----+
    |         |
   Yes        No → 에러: STORE_NOT_FOUND
    |
    v
+------------------+
| 테이블 번호 검증 |
+--------+---------+
         |
    유효? |
    +----+----+
    |         |
   Yes        No → 에러: TABLE_NOT_FOUND
    |
    v
+------------------+
| 비밀번호 검증    |
+--------+---------+
         |
    일치? |
    +----+----+
    |         |
   Yes        No → 에러: AUTH_FAILED
    |
    v
+------------------+
| 세션 확인/생성   |
+--------+---------+
         |
  활성 세션 있음?
    +----+----+
    |         |
   Yes        No → 새 세션 생성
    |         |
    +---------+
         |
         v
+------------------+
| JWT 토큰 발급    |
+------------------+
         |
         v
[로그인 성공 응답]
```

### 1.2 관리자 로그인 플로우

```
[관리자 로그인 요청]
        |
        v
+------------------+
| 매장 ID 검증     |
+--------+---------+
         |
    유효? |
    +----+----+
    |         |
   Yes        No → 에러: STORE_NOT_FOUND
    |
    v
+------------------+
| 사용자명 검증    |
+--------+---------+
         |
    존재? |
    +----+----+
    |         |
   Yes        No → 에러: AUTH_FAILED
    |
    v
+------------------+
| 비밀번호 검증    |
+--------+---------+
         |
    일치? |
    +----+----+
    |         |
   Yes        No → 에러: AUTH_FAILED
    |
    v
+------------------+
| JWT 토큰 발급    |
| (16시간 유효)    |
+------------------+
         |
         v
[로그인 성공 응답]
```

---

## 2. 주문 프로세스

### 2.1 주문 생성 플로우

```
[주문 생성 요청]
        |
        v
+------------------+
| 세션 유효성 검증 |
+--------+---------+
         |
    유효? |
    +----+----+
    |         |
   Yes        No → 에러: SESSION_INVALID
    |
    v
+------------------+
| 주문 항목 검증   |
| - 메뉴 존재 확인 |
| - 수량 > 0 확인  |
+--------+---------+
         |
    유효? |
    +----+----+
    |         |
   Yes        No → 에러: VALIDATION_ERROR
    |
    v
+------------------+
| 주문 번호 생성   |
| (YYYYMMDD-NNN)   |
+--------+---------+
         |
         v
+------------------+
| 주문 항목 생성   |
| - 메뉴 스냅샷    |
| - 소계 계산      |
+--------+---------+
         |
         v
+------------------+
| 총 금액 계산     |
+--------+---------+
         |
         v
+------------------+
| 주문 저장        |
| (트랜잭션)       |
+--------+---------+
         |
         v
+------------------+
| SSE 브로드캐스트 |
| (관리자에게)     |
+------------------+
         |
         v
[주문 성공 응답]
```

### 2.2 주문 번호 생성 로직

```python
def generate_order_number(store_id: str, date: date) -> str:
    # 1. 해당 매장의 오늘 주문 수 조회
    today_count = get_today_order_count(store_id, date)
    
    # 2. 순차 번호 생성
    sequence = today_count + 1
    
    # 3. 주문 번호 포맷
    return f"{date.strftime('%Y%m%d')}-{sequence:03d}"
    
    # 예: 20260204-001, 20260204-002, ...
```

### 2.3 주문 상태 변경 플로우

```
[상태 변경 요청]
        |
        v
+------------------+
| 주문 존재 확인   |
+--------+---------+
         |
    존재? |
    +----+----+
    |         |
   Yes        No → 에러: NOT_FOUND
    |
    v
+------------------+
| 상태 전이 검증   |
+--------+---------+
         |
    유효? |
    +----+----+
    |         |
   Yes        No → 에러: INVALID_STATUS_TRANSITION
    |
    v
+------------------+
| 상태 업데이트    |
+--------+---------+
         |
         v
+------------------+
| SSE 브로드캐스트 |
| (고객+관리자)    |
+------------------+
         |
         v
[상태 변경 성공]
```

---

## 3. 테이블 세션 프로세스

### 3.1 세션 시작 (테이블 로그인 시)

```
[테이블 로그인]
        |
        v
+------------------+
| 활성 세션 확인   |
+--------+---------+
         |
    있음? |
    +----+----+
    |         |
   Yes        No
    |         |
    |         v
    |    +------------------+
    |    | 새 세션 생성     |
    |    | - started_at     |
    |    | - is_active=true |
    |    +------------------+
    |         |
    +---------+
         |
         v
[세션 ID 반환]
```

### 3.2 세션 종료 (이용 완료)

```
[이용 완료 요청]
        |
        v
+------------------+
| 세션 존재 확인   |
+--------+---------+
         |
    존재? |
    +----+----+
    |         |
   Yes        No → 에러: SESSION_NOT_FOUND
    |
    v
+------------------+
| 세션 주문 조회   |
+--------+---------+
         |
         v
+------------------+
| 주문 아카이브    |
| (OrderHistory)   |
+--------+---------+
         |
         v
+------------------+
| 원본 주문 삭제   |
+--------+---------+
         |
         v
+------------------+
| 세션 종료 처리   |
| - completed_at   |
| - is_active=false|
+------------------+
         |
         v
[이용 완료 성공]
```

---

## 4. 메뉴/카테고리 관리 프로세스

### 4.1 카테고리 삭제 플로우

```
[카테고리 삭제 요청]
        |
        v
+------------------+
| 카테고리 존재 확인|
+--------+---------+
         |
    존재? |
    +----+----+
    |         |
   Yes        No → 에러: NOT_FOUND
    |
    v
+------------------+
| 메뉴 존재 확인   |
+--------+---------+
         |
  메뉴 있음?
    +----+----+
    |         |
   Yes        No
    |         |
    v         v
에러:      +------------------+
CATEGORY   | 카테고리 삭제    |
_HAS_MENUS +------------------+
                  |
                  v
           [삭제 성공]
```

### 4.2 메뉴 삭제 플로우

```
[메뉴 삭제 요청]
        |
        v
+------------------+
| 메뉴 존재 확인   |
+--------+---------+
         |
    존재? |
    +----+----+
    |         |
   Yes        No → 에러: NOT_FOUND
    |
    v
+------------------+
| 메뉴 삭제        |
| (스냅샷 유지)    |
+------------------+
         |
         v
[삭제 성공]

* 기존 주문의 OrderItem은 스냅샷(menu_name, unit_price)으로 유지됨
```

---

## 5. SSE 이벤트 모델

### 5.1 이벤트 타입

| 이벤트 | 대상 | 트리거 |
|--------|------|--------|
| `new_order` | Admin | 새 주문 생성 |
| `order_updated` | Admin, Customer | 주문 상태 변경 |
| `order_deleted` | Admin, Customer | 주문 삭제 |

### 5.2 이벤트 페이로드

```json
// new_order
{
  "type": "new_order",
  "data": {
    "order_id": 123,
    "order_number": "20260204-001",
    "table_number": 5,
    "items": [...],
    "total_amount": 25000,
    "status": "PENDING",
    "created_at": "2026-02-04T12:30:00Z"
  }
}

// order_updated
{
  "type": "order_updated",
  "data": {
    "order_id": 123,
    "status": "PREPARING"
  }
}

// order_deleted
{
  "type": "order_deleted",
  "data": {
    "order_id": 123
  }
}
```
